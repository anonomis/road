// Generated by CoffeeScript 1.6.2
(function() {
  var CommonTool, RoadTool, StraightRoadTool, Tool, root,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  root = this;

  Tool = (function() {
    function Tool() {
      console.log("setting tool", this);
      tools.current = this;
    }

    return Tool;

  })();

  CommonTool = (function(_super) {
    __extends(CommonTool, _super);

    function CommonTool() {}

    CommonTool.prototype.over = function(ent) {
      if (ent instanceof ents.Node) {
        return new RoadTool(ent);
      }
    };

    return CommonTool;

  })(Tool);

  RoadTool = (function(_super) {
    __extends(RoadTool, _super);

    function RoadTool(node) {
      this.node = node != null ? node : null;
      this.click = __bind(this.click, this);
      RoadTool.__super__.constructor.call(this);
    }

    RoadTool.prototype.click = function(e) {
      if (this.curve != null) {
        layers.main.drawBeizer(this.curve);
        this.endNode = new ents.Node(this.curve.p3, this.curve.p2);
        return tools.current = new RoadTool(this.endNode);
      }
    };

    RoadTool.prototype.bezier = function(end) {
      var etarg, mid, perp, sta, starg;

      sta = this.node.pos;
      starg = this.node.line.growAdd(L(sta, end).length() / 2.5).p1;
      mid = this.node.pos.add(end).div(2);
      perp = L(this.node.pos, end).perp().growAll(1000);
      etarg = starg.mirror(perp);
      layers.tool.drawDot(starg, "#0F0");
      layers.tool.drawDot(mid, "#00F");
      layers.tool.drawLine(perp, "#0FF");
      layers.tool.drawDot(etarg, "#F0F");
      return C({
        p0: sta,
        p1: starg,
        p2: etarg,
        p3: end
      });
    };

    RoadTool.prototype.over = function(ent) {
      if (ent instanceof ents.Node) {
        layers.tool.clear();
        layers.tool.drawNode(this.node, true);
        layers.tool.drawBeizer(this.bezier(ent.pos));
        return this.endNode = ent;
      }
    };

    RoadTool.prototype.out = function(ent) {
      if (ent instanceof ents.Node) {
        return this.endNode = null;
      }
    };

    RoadTool.prototype.move = function(e) {
      var angle, color, curve, green, len, steepness;

      if (this.endNode == null) {
        layers.tool.clear();
        layers.tool.drawNode(this.node, true);
        curve = this.bezier(P(e));
        angle = Math.abs(L(curve.p0, curve.p1).signedAngle(L(curve.p2, curve.p3)));
        len = curveLen(curve);
        if (angle > Math.PI / 2) {
          steepness = 255;
          color = "#333";
        } else {
          steepness = Math.max(0, ((0.028 - (angle / len)) * 20) - .30);
          green = 1 - steepness;
          color = "hsb(" + steepness + ", 0.9, 0.5)";
          this.curve = curve;
        }
        console.log(angle, steepness, len);
        if (this.curve != null) {
          return layers.tool.drawBeizer(this.curve, color);
        }
      }
    };

    RoadTool.prototype.keyDown = function(e) {
      if (e.which === 17) {
        return tools.current = new StraightRoadTool(this.node);
      }
    };

    return RoadTool;

  })(Tool);

  StraightRoadTool = (function(_super) {
    __extends(StraightRoadTool, _super);

    function StraightRoadTool(node) {
      this.node = node != null ? node : null;
      StraightRoadTool.__super__.constructor.call(this);
    }

    StraightRoadTool.prototype.click = function(e) {
      var line, node;

      line = this.straightLineFromNode(this.node, P(e));
      layers.main.drawLine(line);
      node = new ents.Node(line.p1, line.p0);
      return tools.current = new RoadTool(node);
    };

    StraightRoadTool.prototype.move = function(e) {
      var line;

      layers.tool.clear();
      line = this.straightLineFromNode(this.node, P(e));
      return layers.tool.drawLine(line);
    };

    StraightRoadTool.prototype.straightLineFromNode = function(node, pos) {
      var line, loc;

      line = L(node.pos, node.ctrl).growAdd(1000);
      loc = jsBezier.nearestPointOnCurve(pos, this.lineToBez(line)).location;
      return L(node.pos, node.ctrl).growAdd(1000 * loc);
    };

    StraightRoadTool.prototype.lineToBez = function(l) {
      return [
        {
          x: l.p0.x,
          y: l.p0.y
        }, {
          x: l.p0.x,
          y: l.p0.y
        }, {
          x: l.p1.x,
          y: l.p1.y
        }, {
          x: l.p1.x,
          y: l.p1.y
        }
      ];
    };

    StraightRoadTool.prototype.keyUp = function(e) {
      if (e.which === 17) {
        return tools.current = new RoadTool(this.node);
      }
    };

    return StraightRoadTool;

  })(Tool);

  root.tools = {};

  root.tools.current = new CommonTool();

  root.tools.RoadTool = RoadTool;

}).call(this);
