// Generated by CoffeeScript 1.6.2
(function() {
  var ArcTool, Bezier, BezierTool, Edge, Layer, LineTool, Node, NodeTool, RoadTool, findNode, hotkeys, registerHotkey, root, zIndex,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  root = this;

  requirejs(['./node_modules/straightcurve/lib/arc2', './node_modules/straightcurve/lib/vector2', './node_modules/straightcurve/lib/vertex2', './node_modules/straightcurve/lib/line2', './node_modules/straightcurve/lib/circle2', './node_modules/straightcurve/lib/line2'], function() {
    return requirejs(['./node_modules/straightcurve/lib/distancer', 'raphael'], function(a, Raphael) {
      var height, j, width;

      j = $;
      root.layers = {
        main: new Layer('main'),
        node: new Layer('node'),
        tool: new Layer('tool')
      };
      width = $('body').width();
      height = $('body').height();
      j("body").append($('<div id="mouseTrap" style="border:1px solid #aaa; background-color:rgba(0,0,0,0);    position: absolute; left: 0; top: 0; bottom: 0; z-index: 111;      width: 10000px; height: 10000px;"></div>'));
      j("#mouseTrap").click(function(e) {
        return typeof currentTool.click === "function" ? currentTool.click(e) : void 0;
      });
      j("#mouseTrap").mousemove(function(e) {
        return typeof currentTool.mousemove === "function" ? currentTool.mousemove(e) : void 0;
      });
      j("#mouseTrap").mousedown(function(e) {
        return typeof currentTool.mousedown === "function" ? currentTool.mousedown(e) : void 0;
      });
      return window.currentTool = new NodeTool();
    });
  });

  hotkeys = {};

  $(window).keypress(function(e) {
    var _name;

    console.log(e.which);
    return typeof hotkeys[_name = event.which] === "function" ? hotkeys[_name]() : void 0;
  });

  registerHotkey = function(key, func) {
    return hotkeys[key] = func;
  };

  registerHotkey(49, function() {
    return window.currentTool = new NodeTool();
  });

  registerHotkey(50, function() {
    return window.currentTool = new BezierTool();
  });

  window.ctrlHold = false;

  $(window).keydown(function(e) {
    if (e.which === 17) {
      return window.ctrlHold = true;
    }
  });

  $(window).keyup(function(e) {
    if (e.which === 17) {
      return window.ctrlHold = false;
    }
  });

  $(window).blur(function(e) {
    return window.ctrlHold = false;
  });

  LineTool = (function() {
    function LineTool() {
      this.mousemove = __bind(this.mousemove, this);
      this.click = __bind(this.click, this);      this.p1 = null;
      this.p2 = null;
      this.step = 0;
    }

    LineTool.prototype.click = function(e) {
      var _ref;

      if ((_ref = this.clickSteps[this.step]) != null) {
        _ref.call(this, e);
      }
      return this.step++;
    };

    LineTool.prototype.clickSteps = {
      0: function(e) {
        return this.p1 = P(e);
      },
      1: function(e) {
        return this.p2 = P(e);
      },
      2: function(e) {
        layers.main.drawLine(L(this.p1, this.p2));
        return window.currentTool = new LineTool();
      }
    };

    LineTool.prototype.mousemove = function(e) {
      var _ref;

      return (_ref = this.mousemoveSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    LineTool.prototype.mousemoveSteps = {
      0: function(e) {},
      1: function(e) {
        layers.tool.clear();
        if (this.p1 != null) {
          return layers.tool.drawLine(L(this.p1, P(e)));
        }
      },
      2: function(e) {}
    };

    return LineTool;

  })();

  RoadTool = (function() {
    function RoadTool() {
      this.mousemove = __bind(this.mousemove, this);
      this.mousedown = __bind(this.mousedown, this);
      this.click = __bind(this.click, this);      this.p1 = null;
      this.step = 0;
      this.mousePressed = false;
    }

    RoadTool.prototype.click = function(e) {};

    RoadTool.prototype.clickSteps = {
      0: function(e) {},
      1: function(e) {},
      2: function(e) {}
    };

    RoadTool.prototype.mousedown = function(e) {
      return this.mousePressed = true;
    };

    RoadTool.prototype.mousemove = function(e) {
      var _ref;

      return (_ref = this.mousemoveSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    RoadTool.prototype.mousemoveSteps = {
      0: function(e) {
        layers.tool.clear();
        return this.road.draw(layers.tool.ctx);
      },
      1: function(e) {
        layers.tool.clear();
        return this.road.draw(layers.tool.ctx);
      },
      2: function(e) {}
    };

    return RoadTool;

  })();

  findNode = function(e) {
    var foundNode, node, p, x, y, _i, _j, _ref, _ref1, _ref2, _ref3;

    p = P(e);
    node = null;
    foundNode = false;
    for (x = _i = _ref = p.x - 5, _ref1 = p.x + 5; _ref <= _ref1 ? _i < _ref1 : _i > _ref1; x = _ref <= _ref1 ? ++_i : --_i) {
      if (nodes[x] != null) {
        for (y = _j = _ref2 = p.y - 5, _ref3 = p.y + 5; _ref2 <= _ref3 ? _j < _ref3 : _j > _ref3; y = _ref2 <= _ref3 ? ++_j : --_j) {
          node = nodes[x][y];
          if (node != null) {
            foundNode = true;
            break;
          }
        }
      }
      if (foundNode) {
        break;
      }
    }
    return node;
  };

  /*
  redrawNodes = () ->
    layers.node.clear()
    for nodeY in nodes
      if nodeY?
        for node in nodeY
          node?.draw?()
  */


  NodeTool = (function() {
    function NodeTool() {
      this.mousemove = __bind(this.mousemove, this);
      this.click = __bind(this.click, this);      this.p0 = null;
      this.p1 = null;
      this.step = 0;
    }

    NodeTool.prototype.click = function(e) {
      var _ref;

      return (_ref = this.clickSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    NodeTool.prototype.clickSteps = {
      0: function(e) {
        if (this.node != null) {
          return window.currentTool = new BezierTool(this.node);
        } else {
          this.p0 = P(e);
          return this.step++;
        }
      },
      1: function(e) {
        new Edge(this.p0, P(e));
        return window.currentTool = new NodeTool();
      }
    };

    NodeTool.prototype.mousemove = function(e) {
      var _ref;

      return (_ref = this.mousemoveSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    NodeTool.prototype.mousemoveSteps = {
      0: function(e) {
        layers.tool.clear();
        this.node = findNode(e);
        if (this.node != null) {
          return layers.tool.drawNode(this.node, true);
        } else {
          return layers.tool.drawImpasse(P(e));
        }
      },
      1: function(e) {
        var line;

        line = L(this.p0, P(e));
        layers.tool.clear();
        layers.tool.drawRoad(line);
        return layers.tool.drawImpasse(this.p0);
      }
    };

    return NodeTool;

  })();

  Edge = (function() {
    function Edge(p0, p1) {
      this.p0 = p0;
      this.p1 = p1;
      this.n0 = new Node(this.p0, this.p1);
      this.n1 = new Node(this.p1, this.p0);
      this.line = L(this.p0, this.p1);
      this.draw();
    }

    Edge.prototype.draw = function() {
      layers.main.drawRoad(this.line);
      return layers.main.drawImpasse(this.p0);
    };

    return Edge;

  })();

  Node = (function() {
    function Node(pos, target) {
      this.pos = pos;
      this.target = target;
      this.line = L(this.target, this.pos);
      this.ctrl = this.line.growAdd(50).p1;
      if (nodes[this.pos.x] == null) {
        root.nodes[this.pos.x] = [];
      }
      root.nodes[this.pos.x][this.pos.y] = this;
      layers.node.drawNode(this);
    }

    return Node;

  })();

  ArcTool = (function() {
    function ArcTool() {
      this.mousemove = __bind(this.mousemove, this);
      this.click = __bind(this.click, this);      this.p1 = null;
      this.p2 = null;
      this.step = 0;
    }

    ArcTool.prototype.click = function(e) {
      var _ref;

      if ((_ref = this.clickSteps[this.step]) != null) {
        _ref.call(this, e);
      }
      return this.step++;
    };

    ArcTool.prototype.clickSteps = {
      0: function(e) {
        return this.p1 = P(e);
      },
      1: function(e) {
        return this.p2 = P(e);
      },
      2: function(e) {
        layers.main.drawArc(new Arc2(this.p1, P(e), this.p2));
        return window.currentTool = new ArcTool();
      }
    };

    ArcTool.prototype.mousemove = function(e) {
      var _ref;

      return (_ref = this.mousemoveSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    ArcTool.prototype.mousemoveSteps = {
      0: function(e) {},
      1: function(e) {},
      2: function(e) {
        layers.tool.clear();
        return layers.tool.drawArc(new Arc2(this.p1, P(e), this.p2));
      }
    };

    return ArcTool;

  })();

  BezierTool = (function() {
    function BezierTool(node) {
      this.node = node != null ? node : null;
      this.mousemove = __bind(this.mousemove, this);
      this.click = __bind(this.click, this);
      this.p1 = null;
      this.p2 = null;
      this.p3 = null;
      this.p4 = null;
      if (this.node == null) {
        this.step = 0;
      } else {
        this.step = 1;
      }
    }

    BezierTool.prototype.click = function(e) {
      var _ref;

      return (_ref = this.clickSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    BezierTool.prototype.clickSteps = {
      0: function(e) {
        if (this.node != null) {
          return this.step++;
        }
      },
      1: function(e) {
        var bezier, node;

        bezier = this.bezier(e);
        layers.main.drawBeizer(bezier);
        node = new Node(bezier.p3, bezier.p2);
        return window.currentTool = new BezierTool(node);
      },
      2: function(e) {
        this.p2 = P(e);
        return this.step++;
      },
      3: function(e) {
        return layers.main.drawBeizer({
          p0: this.p0,
          p1: P(e),
          p2: this.p2,
          p3: this.p1
        });
      }
    };

    BezierTool.prototype.mousemove = function(e) {
      var _ref;

      return (_ref = this.mousemoveSteps[this.step]) != null ? _ref.call(this, e) : void 0;
    };

    BezierTool.prototype.findNode = function(e) {
      var foundNode, node, p, x, y, _i, _j, _ref, _ref1, _ref2, _ref3;

      p = P(e);
      node = null;
      foundNode = false;
      for (x = _i = _ref = p.x - 5, _ref1 = p.x + 5; _ref <= _ref1 ? _i < _ref1 : _i > _ref1; x = _ref <= _ref1 ? ++_i : --_i) {
        if (nodes[x] != null) {
          for (y = _j = _ref2 = p.y - 5, _ref3 = p.y + 5; _ref2 <= _ref3 ? _j < _ref3 : _j > _ref3; y = _ref2 <= _ref3 ? ++_j : --_j) {
            node = nodes[x][y];
            if (node != null) {
              node.highLight();
              foundNode = true;
              break;
            }
          }
        }
        if (foundNode) {
          break;
        }
      }
      return node;
    };

    BezierTool.prototype.bezier = function(e) {
      var end, etarg, mid, sta, starg;

      sta = this.node.pos;
      end = P(e);
      mid = this.node.line.growAdd(100).p1;
      starg = this.node.ctrl;
      etarg = P(end.x + ((mid.x - end.x) / 2), end.y + ((mid.y - end.y) / 2));
      layers.tool.drawDot(starg, "#0F0");
      layers.tool.drawDot(mid);
      layers.tool.drawDot(etarg, "#F0F");
      return {
        p0: sta,
        p1: starg,
        p2: etarg,
        p3: end
      };
    };

    BezierTool.prototype.mousemoveSteps = {
      0: function(e) {
        var foundNode, p, x, y, _i, _j, _ref, _ref1, _ref2, _ref3;

        p = P(e);
        foundNode = false;
        for (x = _i = _ref = p.x - 5, _ref1 = p.x + 5; _ref <= _ref1 ? _i < _ref1 : _i > _ref1; x = _ref <= _ref1 ? ++_i : --_i) {
          if (nodes[x] != null) {
            for (y = _j = _ref2 = p.y - 5, _ref3 = p.y + 5; _ref2 <= _ref3 ? _j < _ref3 : _j > _ref3; y = _ref2 <= _ref3 ? ++_j : --_j) {
              this.node = nodes[x][y];
              if (this.node != null) {
                this.node.highLight();
                foundNode = true;
                break;
              }
            }
          }
          if (foundNode) {
            break;
          }
        }
        if (!foundNode) {
          layers.tool.clear();
          return this.node = null;
        }
      },
      1: function(e) {
        var node;

        if (ctrlHold) {
          node = this.findNode(e);
          if (node != null) {
            this.node2 = node;
            layers.tool.clear();
            layers.tool.drawNode(this.node, true);
            layers.tool.drawNode(this.node2, true);
            layers.tool.drawBeizer({
              p0: this.node.perp.p0,
              p1: this.node.perp.p1,
              p2: this.node2.perp.p1,
              p3: this.node2.perp.p0
            });
            return;
          }
        }
        layers.tool.clear();
        layers.tool.drawNode(this.node, true);
        return layers.tool.drawBeizer(this.bezier(e));
      },
      2: function(e) {
        layers.tool.clear();
        return layers.tool.drawArc(new Arc2(this.p0, P(e), this.p1));
      },
      3: function(e) {
        var currentTool;

        layers.tool.clear();
        layers.tool.drawBeizer({
          p0: this.pos,
          p1: P(e),
          p2: this.p2,
          p3: this.p1
        });
        return currentTool = new BezierTool();
      }
    };

    return BezierTool;

  })();

  zIndex = 0;

  Layer = (function() {
    function Layer(id) {
      var div, height, width;

      this.w = width = $('body').width();
      this.h = height = $('body').height();
      div = $("<div id='" + id + "'></div>");
      div.css({
        "border": "1px solid #aaa",
        "background-color": "rgba(0,0,0,0)",
        "position": "absolute"
      }, "left: 0", "top: 0", {
        "z-index": zIndex++,
        "width": width + "px",
        "height": height + "px"
      });
      $('body').append(div);
      this.ctx = new Raphael(id, 10000, 10000);
      this.clear();
    }

    Layer.prototype.clear = function() {
      return this.ctx.clear();
    };

    Layer.prototype.drawLine = function(line) {
      return this.ctx.path("M " + line.p0.x + " " + line.p0.y + " L " + line.p1.x + " " + line.p1.y);
    };

    Layer.prototype.drawArc = function(arc) {
      var line, lines, _i, _len, _results;

      lines = arc.segmentize(30);
      _results = [];
      for (_i = 0, _len = lines.length; _i < _len; _i++) {
        line = lines[_i];
        _results.push(this.drawLine(line));
      }
      return _results;
    };

    Layer.prototype.drawBeizer = function(beizer) {
      var c;

      c = this.ctx.path("M " + beizer.p0.x + " " + beizer.p0.y + "\nC " + beizer.p1.x + "\n" + beizer.p1.y + "\n" + beizer.p2.x + "\n" + beizer.p2.y + "\n" + beizer.p3.x + "\n" + beizer.p3.y);
      c.attr("stroke-width", "9");
      return c.attr("stroke", "#eee");
    };

    Layer.prototype.drawDot = function(pos, color) {
      var c;

      if (color == null) {
        color = "#505";
      }
      c = this.ctx.circle(pos.x, pos.y, 4);
      return c.attr("fill", color);
    };

    Layer.prototype.drawRoad = function(line) {
      var c;

      c = this.ctx.path("M" + line.p0.x + " " + line.p0.y + " L" + line.p1.x + " " + line.p1.y + " ");
      c.attr("stroke-width", "9");
      return c.attr("stroke", "#eee");
    };

    Layer.prototype.drawNode = function(node, large) {
      var c, t;

      if (large == null) {
        large = false;
      }
      if (large) {
        c = this.ctx.circle(node.pos.x, node.pos.y, 8);
      } else {
        c = this.ctx.circle(node.pos.x, node.pos.y, 4);
      }
      c.attr("fill", "#500");
      c.attr("stroke", "#eee");
      t = this.ctx.circle(node.ctrl.x, node.ctrl.y, 10);
      t.attr("fill", "#500");
      return t.attr("stroke", "#eee");
    };

    Layer.prototype.drawImpasse = function(pos) {
      var c;

      c = this.ctx.circle(pos.x, pos.y, 10);
      c.attr("fill", "#555");
      return c.attr("stroke", "#999");
    };

    return Layer;

  })();

  root.nodes = [];

  Bezier = (function() {
    function Bezier(start, end, controlpoints) {
      this.start = start;
      this.end = end;
      this.controlpoints = controlpoints != null ? controlpoints : [];
      this.cordinateArray = _.flatten([this.start, this.controllpoints, this.end]);
    }

    return Bezier;

  })();

}).call(this);

/*
//@ sourceMappingURL=main.map
*/
